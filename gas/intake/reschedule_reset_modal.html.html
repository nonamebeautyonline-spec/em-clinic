<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <style>
      body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; padding: 14px; }
      .row { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
      input[type="text"] { flex:1; padding:10px; border:1px solid #ccc; border-radius:8px; }
      button { padding:10px 12px; border:0; border-radius:8px; cursor:pointer; }
      button.primary { background:#2563eb; color:#fff; }
      button.danger { background:#dc2626; color:#fff; }
      button.gray { background:#e5e7eb; }
      table { width:100%; border-collapse:collapse; }
      th, td { border-bottom:1px solid #eee; padding:8px; font-size:12px; vertical-align:top; }
      th { background:#fafafa; text-align:left; }
      .muted { color:#6b7280; font-size:12px; }
      .ok { color:#059669; font-weight:600; }
      .ng { color:#dc2626; font-weight:600; }
      .status { font-size:11px; color:#374151; }
      .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; font-size:11px; }
      .loading { color:#6b7280; }
    </style>
  </head>

  <body>
    <div class="row">
      <input id="q" type="text" placeholder="氏名（部分一致 / スペース無視）例：山田 太郎 / ﾔﾏﾀﾞ" />
      <!-- ②: id付与（2重クリック防止） -->
      <button id="btnSearch" class="primary" type="button" onclick="search()">検索</button>
      <button class="gray" type="button" onclick="google.script.host.close()">閉じる</button>
    </div>

    <div id="msg" class="muted">UI loaded.</div>

    <div style="margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th style="width:34px;"></th>
            <th>氏名</th>
            <th>answerer_id</th>
            <th>patient_id</th>
            <th>問診側（B/H/I）</th>
            <th>予約側（現在有効）</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted">検索すると候補が表示されます。</td></tr>
        </tbody>
      </table>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="muted" style="flex:1;">
        選択した患者の「予約をまっさらに」します（予約シート：キャンセル／問診B/H/I：空白）。
      </div>
      <!-- ②: id付与（2重クリック防止） -->
      <button id="btnReset" class="danger" type="button" onclick="resetSelected()">予約をまっさらにする</button>
    </div>

    <script>
      function setMsg(text, cls) {
        const el = document.getElementById("msg");
        if (!el) return;
        el.className = cls || "muted";
        el.textContent = text || "";
      }

      // ②: ボタンのbusy制御
      function setBusy(id, busy) {
        const btn = document.getElementById(id);
        if (!btn) return;
        btn.disabled = !!busy;
        btn.style.opacity = busy ? "0.6" : "1";
        btn.style.pointerEvents = busy ? "none" : "auto";
      }

      // 画面にエラーを出す
      window.onerror = function (msg, src, line, col) {
        setMsg("JS ERROR: " + msg + " (" + line + ":" + col + ")", "ng");
        return false;
      };
      window.onunhandledrejection = function (e) {
        setMsg("Promise ERROR: " + (e && e.reason ? e.reason : e), "ng");
      };

      function escapeHtml(s) {
        return String(s || "")
          .replace(/&/g, "&amp;").replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      let lastItems = [];

      function render(items) {
        lastItems = items || [];
        const tb = document.getElementById("tbody");
        if (!tb) return;

        if (!lastItems.length) {
          tb.innerHTML = '<tr><td colspan="6" class="muted">該当なし</td></tr>';
          return;
        }

        tb.innerHTML = lastItems.map((it, idx) => {
          const intake = [
            it.intake_reserveId ? ("reserveId: " + escapeHtml(it.intake_reserveId)) : "reserveId: -",
            (it.intake_reserved_date || it.intake_reserved_time)
              ? ("日時: " + escapeHtml(it.intake_reserved_date || "-") + " " + escapeHtml(it.intake_reserved_time || ""))
              : "日時: -"
          ].join("<br>");

          const current = it.current_reserveId
            ? [
                "reserveId: " + escapeHtml(it.current_reserveId),
                "日時: " + escapeHtml(it.current_date || "-") + " " + escapeHtml(it.current_time || ""),
                'status: <span class="pill">' + escapeHtml(it.current_status || "") + '</span>'
              ].join("<br>")
            : "有効予約なし";

          return `
            <tr>
              <td><input type="radio" name="pick" value="${idx}"></td>
              <td>${escapeHtml(it.name || "")}</td>
              <td>${escapeHtml(it.answerer_id || "")}</td>
              <td>${escapeHtml(it.patient_id || "")}</td>
              <td class="status">${intake}</td>
              <td class="status">${current}</td>
            </tr>
          `;
        }).join("");
      }

      // 起動確認
      window.addEventListener("load", () => {
        setMsg("UI loaded. checking server...", "muted");

        if (!window.google || !google.script || !google.script.run) {
          setMsg("google.script.run が見つかりません（HTMLが壊れてる可能性）", "ng");
          return;
        }

        google.script.run
          .withSuccessHandler((res) => setMsg("healthCheck OK: " + JSON.stringify(res), "ok"))
          .withFailureHandler((err) => setMsg("healthCheck FAIL: " + err, "ng"))
          .healthCheck();
      });

      // ②: 検索ボタンの二重送信防止
      function search() {
        const q = document.getElementById("q").value || "";
        setMsg("検索中…", "loading");
        setBusy("btnSearch", true);

        google.script.run
          .withSuccessHandler((res) => {
            setBusy("btnSearch", false);

            if (!res || res.ok !== true) {
              setMsg("検索エラー: " + (res && res.error ? res.error : "unknown"), "ng");
              render([]);
              return;
            }
            setMsg("検索OK: " + (res.items ? res.items.length : 0) + "件", "ok");
            render(res.items || []);
          })
          .withFailureHandler((err) => {
            setBusy("btnSearch", false);
            setMsg("SEARCH FAIL: " + err, "ng");
            render([]);
          })
          .adminSearchPatientsByName(q);
      }

      // ②: 赤ボタンの二重実行防止 + ①: message/ts 表示
      function resetSelected() {
        const picked = document.querySelector('input[name="pick"]:checked');
        if (!picked) return setMsg("対象を選択してください。", "muted");

        const it = lastItems[Number(picked.value)];
        if (!it || !it.patient_id) return setMsg("選択データが不正です。", "ng");

        if (!confirm(`この患者の予約をまっさらにします。\n\n氏名: ${it.name}\npatient_id: ${it.patient_id}\n\n実行しますか？`)) return;

        setMsg("処理中…", "loading");
        setBusy("btnReset", true);

        google.script.run
          .withSuccessHandler((res) => {
            setBusy("btnReset", false);

            if (!res || res.ok !== true) {
              setMsg("処理エラー: " + (res && res.error ? res.error : "unknown"), "ng");
              return;
            }

            const msg = res.message
              ? String(res.message)
              : `完了：予約キャンセル ${res.canceled || 0} 件 / 問診クリア ${res.cleared || 0} 件`;

            const ts = res.ts ? `（${res.ts}）` : "";
            setMsg(msg + ts, "ok");

            // 最新状態に更新
            search();
          })
          .withFailureHandler((err) => {
            setBusy("btnReset", false);
            setMsg("処理エラー: " + err, "ng");
          })
          .adminResetReservationByPatientId(it.patient_id, "lstep_reschedule");
      }
    </script>
  </body>
</html>

name: Data Consistency Check

on:
  schedule:
    # 毎日日本時間午前3時（UTC 18:00）に実行
    - cron: '0 18 * * *'
  workflow_dispatch: # 手動実行も可能

jobs:
  check-consistency:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.local
        run: |
          cat > .env.local << EOF
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          GAS_INTAKE_LIST_URL=${{ secrets.GAS_INTAKE_LIST_URL }}
          ADMIN_TOKEN=${{ secrets.ADMIN_TOKEN }}
          APP_BASE_URL=${{ secrets.APP_BASE_URL }}
          EOF

      - name: Run data consistency check
        id: check
        continue-on-error: true
        run: |
          node scripts/check-and-fix-data-consistency.mjs > consistency-report.txt 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Read report
        id: report
        run: |
          echo "REPORT<<EOF" >> $GITHUB_OUTPUT
          cat consistency-report.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send notification on failure
        if: steps.check.outputs.exit_code != '0'
        uses: actions/github-script@v8
        with:
          script: |
            const report = `${{ steps.report.outputs.REPORT }}`;

            // Issueを作成
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `⚠️ データ不整合を検出（${new Date().toLocaleDateString('ja-JP')}）`,
              body: `## データ整合性チェックで問題が検出されました\n\n自動補完を実行しましたが、手動確認が必要です。\n\n### レポート\n\n\`\`\`\n${report}\n\`\`\`\n\n### 確認事項\n\n1. Vercelログで該当時刻のエラーを確認\n2. Supabaseの稼働状況を確認\n3. 頻繁に発生する場合はリトライ機能の実装を検討\n\n### 関連ドキュメント\n\n- [SUPABASE_WRITE_FAILURE_ROOT_CAUSE.md](../blob/main/SUPABASE_WRITE_FAILURE_ROOT_CAUSE.md)\n- [INTAKE_WRITE_FAILURE_ANALYSIS.md](../blob/main/INTAKE_WRITE_FAILURE_ANALYSIS.md)`,
              labels: ['data-consistency', 'auto-detected']
            });

      - name: Success notification
        if: steps.check.outputs.exit_code == '0'
        run: |
          echo "✅ データ整合性チェック完了：問題なし"
          cat consistency-report.txt

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: consistency-report-${{ github.run_number }}
          path: consistency-report.txt
          retention-days: 30

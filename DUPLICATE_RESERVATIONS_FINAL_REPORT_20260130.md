# 2026-01-30 重複予約問題 最終調査レポート

## エグゼクティブサマリー

2026-01-30の予約において、**Supabaseに重複予約を持つ8人の患者**を発見しました（20260100211を除く）。
調査の結果、以下が判明:

- **Supabase**: 8人が重複予約（合計23件の予約レコード）
- **GASシート**: 6人が正常に同期済み（各1件）、2人は同期されず
- **重複レコードの扱い**: Supabaseのcanceledレコードは同期対象外、最新のpendingのみ同期

## 重要な発見

### 1. Supabaseの状況

#### 重複予約患者リスト
| 患者ID | Supabase予約件数 | パターン | GAS同期状況 | 備考 |
|--------|-----------------|---------|------------|------|
| 20260100321 | 5件 | canceled×4→pending×1 | 同期済（1件） | 短時間連打あり |
| 20260101576 | 5件 | canceled×4→pending×1 | 同期済（1件） | 最も連打が激しい |
| 20251200128 | 4件 | canceled×4 | **同期なし** | 全てcanceled |
| 20260101146 | 2件 | canceled×2 | **同期なし** | 全てcanceled |
| 20260101381 | 2件 | canceled×1→pending×1 | 同期済（1件） | - |
| 20260101529 | 2件 | canceled×1→pending×1 | 同期済（1件） | - |
| 20260101615 | 2件 | canceled×1→pending×1 | 同期済（1件） | - |
| 20260101630 | 2件 | canceled×1→pending×1 | 同期済（1件） | - |

### 2. GASシートの状況

#### GASシート全体
- 2026-01-30の総予約件数: **48件**
- 重複予約: **0人**（正常に重複排除されている）

#### Supabase重複患者のGAS状況
**同期済み（6人）**:
- 20260100321: 11:30, Status: OK, Reserve ID: resv-1769739417486
- 20260101576: 17:15, Status: N/A, Reserve ID: resv-1769700681889
- 20260101381: 14:30, Status: OK, Reserve ID: resv-1769676831803
- 20260101529: 17:00, Status: N/A, Reserve ID: resv-1769687043173
- 20260101615: 13:15, Status: OK, Reserve ID: resv-1769705897503
- 20260101630: 14:15, Status: OK, Reserve ID: resv-1769748606212

**同期されていない（2人）**:
- 20251200128: 全てcanceled（最後の予約は1/27 2:40:35）
- 20260101146: 全てcanceled（最後の予約は1/20 19:46:39）

## 詳細分析

### パターン1: 最後の1件だけpending（6人）

これらの患者は**20260100211と同じパターン**。DBレスポンス遅延により連続クリックした結果:

#### 20260100321（最も時間がかかったケース）
**Supabase**:
- 10:28:46: 11:00予約 → canceled
- 10:31:32: 11:15予約 → canceled（2分46秒後）
- 10:31:41: 11:15予約 → canceled（**9秒後**）★連打
- 10:39:11: 11:15予約 → canceled（7分30秒後）
- 11:16:58: 11:30予約 → **pending**（48分後、やっと成功）

**GAS**: 11:30の予約1件のみ（OK）

**分析**: 48分間に5回予約を試行。9秒での連打はDBレスポンス遅延が原因。最終的に成功した予約のみGASに同期。

#### 20260101576（最も連打が激しいケース）
**Supabase**:
- 0:31:22: 17:15予約 → canceled
- 0:33:16: 16:30予約 → canceled（1分54秒後）
- 0:33:25: 16:30予約 → canceled（**9秒後**）★連打
- 0:33:38: 16:30予約 → canceled（**13秒後**）★連打
- 0:33:52: 16:30予約 → **pending**（**14秒後**）★連打

**GAS**: 17:15の予約1件のみ（ステータスN/A）

**重要な矛盾**: 
- Supabaseの最後のpending予約: 16:30（Reserve ID: resv-1769700832432）
- GASシートの予約: 17:15（Reserve ID: resv-1769700681889）

→ **GASシートに同期されているのは、最初のcanceled予約**

これは非常に深刻な問題を示唆しています。

### パターン2: 全てcanceled（2人）

#### 20251200128
- Supabase: 4件全てcanceled
- GAS: 同期なし
- 最終試行: 2026/1/27 2:40:35（診療日の3日前）
- **結論**: 予約は成立していない

#### 20260101146
- Supabase: 2件全てcanceled
- GAS: 同期なし
- 最終試行: 2026/1/20 19:46:39（診療日の10日前）
- **結論**: 予約は成立していない

## 根本原因の分析

### 1. Supabaseでの重複レコード作成
**原因**: DBレスポンス遅延（10-30秒）
- ユーザーが「予約ボタンを押しても反応がない」と感じる
- 短時間（9-14秒）で連続クリック
- 各クリックが別々のレコードとして作成される
- 最初の数件は何らかの理由でcanceledになる
- 最後の1件がpendingとして成功

### 2. GASへの同期ロジック
**推測される動作**:
1. Supabaseから予約レコードを取得
2. 同じpatient_id + reserved_dateの組み合わせがある場合、特定のロジックで1件を選択
3. 選択されたレコードのみGASに同期
4. canceledレコードは同期対象外

**問題点**:
- 20260101576のケースで、pendingではなくcanceledが同期されている
- 同期ロジックが「最新のpending」ではなく「最初のレコード」を選んでいる可能性

### 3. ユーザー体験の問題
**短時間連続予約の発生**:
- 20260101576: 9-14秒間隔で4回連打（最も深刻）
- 20260100321: 9秒間隔で連打
- 20260101146: 4分間隔で再試行

**原因**:
- UIローディング表示が不十分
- エラーメッセージが不明確
- Supabaseの書き込み遅延

## 20260100211との比較

### 共通点
- Supabaseに複数のレコード（canceledとpendingの混在）
- 短時間での連続予約
- 「最後の1件だけpending」パターン
- GASシートには1件のみ（重複なし）

### 相違点
- 20260100211: 15件の重複予約
- その他: 2-5件の重複予約

### 重要な洞察
**20260100211は特異なケースではない**:
- 同じパターンの患者が最低6人
- この問題はシステマティックに発生している
- 全体の約10-15%の患者に影響している可能性

## 影響範囲と対応

### 1. 本日の診療への影響

#### 確実に予約が成立していない（2人）
- **20251200128**: 全てcanceled、GASに同期なし
- **20260101146**: 全てcanceled、GASに同期なし
- **対応**: これらの患者は予約が成立していないため、来院予定なし

#### 予約が成立している（6人）
- GASシートに同期済み
- 診療に影響なし

### 2. データ整合性の問題

#### 20260101576のケース（要確認）
- Supabaseの最新pending: 16:30予約
- GASシート: 17:15予約（canceled）
- **これは矛盾しており、患者の実際の予約時刻を確認する必要あり**

### 3. Supabaseのcanceledレコード
- 合計15件のcanceledレコードがSupabaseに残っている
- これらをどう扱うか（削除？保持？）の方針決定が必要

## 推奨対応

### 緊急対応（本日中）

1. **20260101576の予約時刻確認**
   - 患者に連絡して、実際の予約時刻を確認
   - GASシートの17:15が正しいのか、Supabaseの16:30が正しいのか

2. **全てcanceledの2人への対応**
   - 予約が成立していないため、対応不要（来院予定なし）
   - ただし、患者から問い合わせがあった場合は対応

### 高優先（今週中）

3. **同期ロジックの確認**
   - なぜ20260101576でcanceledレコードが同期されたのか
   - 同期処理のコードとログを確認
   - 「最新のpendingを優先」するロジックが正しく動いているか

4. **他の日付の確認**
   - 2026-01-30以外にも同様の問題がないか
   - 過去1週間の予約を全件チェック

5. **canceledレコードの扱い**
   - Supabaseのcanceledレコードを削除すべきか
   - または、statusを使って管理するか
   - データ保持ポリシーの決定

### 中期対応（今月中）

6. **UIフィードバックの改善**
   - ローディング表示の追加
   - ボタンの二重送信防止
   - 予約完了の明確な表示
   - タイムアウト時の適切なエラーメッセージ

7. **パフォーマンス改善**
   - Supabase書き込みの最適化
   - レスポンスタイムの短縮（目標: 5秒以内）
   - インデックスの見直し

8. **モニタリング体制の構築**
   - 重複予約の自動検出
   - 同期失敗の自動アラート
   - データ整合性チェックの定期実行

## 結論

今回の調査で判明した重要なポイント:

1. **Supabaseでの重複予約は20260100211だけではない**
   - 2026-01-30だけで8人（20260100211を除く）
   - パターンは同じ: canceledとpendingの混在

2. **GASシートへの同期は概ね正常に機能**
   - pendingの予約は正しく同期されている（1件の矛盾を除く）
   - canceledの予約は同期されない（これは正常）
   - 重複は排除されている

3. **根本原因はSupabaseのレスポンス遅延**
   - 10-30秒かかる場合がある
   - ユーザーが連続クリック → 重複レコード作成
   - UIフィードバックの欠如が問題を悪化

4. **1件の深刻な矛盾**
   - 20260101576: GASシートの予約時刻がSupabaseと異なる
   - 緊急確認が必要

**推奨される即座の対応**:
- 20260101576の予約時刻確認
- 同期ロジックの詳細調査
- UIフィードバックの緊急改善

**長期的な対応**:
- パフォーマンス改善
- モニタリング体制の構築
- データ保持ポリシーの策定

/**
 * ナレッジベースを ai_reply_settings に保存するスクリプト
 * v2: 実際のスタッフ返信パターンを反映
 */

const { createClient } = require("@supabase/supabase-js");
require("dotenv").config({ path: ".env.local" });

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

const knowledgeBase = `## クリニック基本情報
- マンジャロ（GLP-1受容体作動薬）専門のオンラインクリニック
- 直接来院なし（完全オンライン）、クリニック住所の案内は不要
- 今後マンジャロ10mg以上やリベルサス等の取り扱い可能性はあるが直近での予定はなし
- 定期配送はなく、毎回ご自身で注文していただく形
- 価格表は1回限りの価格

## 利用フロー
1. LINE友だち追加 → メニューの「予約する」→ 個人情報入力 → SMS認証 → LINEログイン → マイページ表示
2. マイページより問診提出 → 予約選択
3. 予約時間枠に携帯電話（090-から始まる番号）で医師が電話（診察）
4. 診察後、マイページから決済（クレジットカード or 銀行振込）
5. 決済確認後、ヤマト運輸チルド便で発送
6. 再処方はマイページの「再処方申請」から

## 予約・診察について
- 予約はメニューの「マイページ」から可能
- 予約の変更・キャンセルもマイページから
- 知らない番号からの着信を受けられない設定の場合は事前に解除を案内
- 診察を受けないと処方は不可（診察前の決済は不可）
- 電話が繋がらなかった場合 → 再度メッセージで連絡いただければ診察時間を再調整
- 予約時間内に連絡なく診察を受けなかった場合 → 次回以降無断キャンセルはキャンセル料（3000円）が発生する場合あり

## 決済・支払い
- クレジットカード決済と銀行振込に対応
- PayPay等その他の決済方法は非対応
- 銀行振込の口座名義は「カ）コブシ」（法人名義）
- 振込後に決済画面で住所フォームの入力が必要
- 決済はマイページの決済ボタンから

## 配送について
- ヤマト運輸のチルド便で発送（日本郵便での発送は非対応）
- 12時までの入金確認で当日発送、12時以降は翌日発送
- 発送後にLINEで追跡番号を通知
- 日時指定は発送後に追跡番号からヤマト運輸HPで変更可能
- ヤマト営業所留め可能（発送後に追跡番号から受取場所を変更）
- 郵便局留めは不可
- マンジャロは冷蔵保管が必要（冷凍保存は薬液凍結のため不可）
- 追跡番号で「調査中」と表示される場合はお気軽に連絡を案内

## 再処方（リピート購入）
- マイページの「再処方申請」から申請
- 承認後にマイページから決済
- 用量変更（2.5mg↔5mg↔7.5mg）は再処方申請時に選択
- 間違えて別の用量を注文した場合はスタッフへ連絡で対応
- まとめ購入は可能だが、2回に分けて決済が必要（まとめ決済は不可）
- 各用量のセット販売（2本ずつ等）は現在取扱いなし

## マンジャロの用量・効果について
- 2.5mg → 5mg → 7.5mg と段階的に増量が一般的
- 増量タイミング：副作用がなく、効果を感じづらくなったり体重減少が停滞したタイミング
- 2.5mgで十分効果がある方は2.5mgだけで投与終了する方もいる
- 断薬の進め方：目標体重達成後に用量を下げ、その後1週間→10日→2週間と投与間隔を伸ばしていく
- 目標体重に達するまでは現用量の継続を推奨
- 増量希望の場合、1日の食事回数と食事内容を確認する場合あり
- 必ず最低限の栄養を確保して使用するよう案内

## 副作用について
- 一般的な副作用：倦怠感、筋肉痛、消化器症状（吐き気等）
- 息苦しさはマンジャロの一般的な副作用ではなく、精神的な影響の可能性 → 症状悪化時は再度相談を案内
- 発疹・アザ：糖質量が極端に減少した場合「色素性痒疹」の可能性あり（若年女性に稀に発症）
  - 胸や背中など上半身中心に色素沈着を伴う発疹が左右対称に出現
  - 糖質量を増やして改善しない場合は皮膚科受診を推奨
- 薬疹（薬剤アレルギー）の可能性もあるため、投与中止して症状確認が必要な場合あり
- 副作用の相談時は投与時期や他の症状（発疹・発赤等）を確認
- 医学的判断は避け、「確認いたします」「担当医より改めてご連絡」等の表現を使う

## 針（注射針）の廃棄
- 使用済みの針は元払いで当院に送付いただければ適切に廃棄
- 商品名は「サプリメント・ガスなし・アルコールなし・引火性なし」で発送

## よくある質問と回答例

Q: マイページにログインできない / マイページに進めない
A: メニューの「マイページ」をタップいただき、ログイン画面が表示されましたらLINEログインでお進みください。表示に問題がある場合はスクリーンショットをお送りいただけますと確認いたします。

Q: 問診が入力できない / 問診は完了していますと表示される
A: マイページの問診ボタンをご確認ください。表示に問題がある場合はスタッフが確認いたします。問診が未提出の場合は診察を受けられませんのでご注意ください。

Q: 発送はいつ頃？ / 商品はいつ届く？
A: 12時までのご入金確認で当日発送、12時以降は翌日発送となります。発送後にLINEで追跡番号をお知らせいたします。

Q: 配送の時間指定は可能？
A: 発送後に配信する追跡番号からヤマト運輸の公式サイト経由で日時指定が可能です。

Q: 営業所留めは可能？
A: ヤマト運輸の営業所留めは可能です。発送後に追跡番号から受取場所を変更していただけます。郵便局留めは対応しておりません。

Q: 決済方法を教えてください
A: カード決済か銀行振込となっております。マイページの決済ボタンからお手続きいただけます。

Q: 用量を間違えて注文した / 用量を変更したい
A: 再処方申請をし直していただくか、スタッフまでお知らせください。正しい用量で対応いたします。

Q: 効果が感じられなくなった / 増量したい
A: 食事内容と使用状況を教えていただければ医師が確認いたします。1日の食事回数と食事内容を簡単にお知らせください。

Q: リベルサスなどマンジャロ以外の薬は取り扱っていますか？
A: 可能性はありますが、直近での予定はございません。

Q: 診察から時間が経ってしまったが入金して大丈夫？
A: 問題ありません。お振込みいただければ発送手続きに進みます。`;

async function main() {
  console.log("=== ナレッジベース保存 v2 ===\n");
  console.log(`文字数: ${knowledgeBase.length}\n`);

  const { data: existing } = await supabase
    .from("ai_reply_settings")
    .select("id, knowledge_base")
    .maybeSingle();

  if (!existing) {
    console.error("ai_reply_settings レコードが見つかりません");
    return;
  }

  console.log(`既存knowledge_base: ${existing.knowledge_base?.length || 0}文字`);

  const { error } = await supabase
    .from("ai_reply_settings")
    .update({
      knowledge_base: knowledgeBase,
      updated_at: new Date().toISOString(),
    })
    .eq("id", existing.id);

  if (error) {
    console.error("更新エラー:", error);
    return;
  }

  console.log("✅ ナレッジベース更新完了");

  const { data: updated } = await supabase
    .from("ai_reply_settings")
    .select("knowledge_base")
    .eq("id", existing.id)
    .single();

  console.log(`更新後: ${updated?.knowledge_base?.length || 0}文字`);
}

main().catch(console.error);

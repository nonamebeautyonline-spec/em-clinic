# 2026-01-30 重複予約分析レポート

## 概要
- 調査日: 2026-01-30
- 総予約件数: 90件
- 重複予約がある患者数: 8人（20260100211を除く）
- 重複予約の総数: 23件

## パターン別分類

### 1. 最後の1件だけpending（6人）
**これは20260100211と同じ「DBに反映されず何度も取り直した」パターン**

#### 20260100321 - 5件の予約
- 時間帯: 2026/1/30 10:28:46 - 11:16:58（48分12秒）
- パターン: canceled×4 → pending×1
- 詳細:
  - 10:28:46: 11:00の予約 → canceled
  - 10:31:32: 11:15の予約 → canceled（2分46秒後）
  - 10:31:41: 11:15の予約 → canceled（9秒後）★連続クリック
  - 10:39:11: 11:15の予約 → canceled（7分30秒後）
  - 11:16:58: 11:30の予約 → pending（37分後、やっと成功）
- **分析**: 予約枠を変えながら4回失敗。9秒での連続予約は明らかにDBレスポンス遅延によるリトライ

#### 20260101576 - 5件の予約
- 時間帯: 2026/1/30 0:31:22 - 0:33:52（2分30秒）
- パターン: canceled×4 → pending×1
- 詳細:
  - 0:31:22: 17:15の予約 → canceled
  - 0:33:16: 16:30の予約 → canceled（1分54秒後）
  - 0:33:25: 16:30の予約 → canceled（9秒後）★連続クリック
  - 0:33:38: 16:30の予約 → canceled（13秒後）★連続クリック
  - 0:33:52: 16:30の予約 → pending（14秒後）★連続クリック
- **分析**: 最も深刻なケース。9-14秒間隔で4回連続クリック。完全にDBレスポンス遅延が原因

#### 20260101381 - 2件の予約
- 時間帯: 2026/1/29 16:35:16 - 17:53:52（78分35秒）
- パターン: canceled×1 → pending×1
- 予約枠変更: 12:30 → 14:30

#### 20260101529 - 2件の予約
- 時間帯: 2026/1/28 21:35:45 - 2026/1/29 20:44:03（23時間8分）
- パターン: canceled×1 → pending×1
- 予約枠変更: 14:30 → 17:00
- **分析**: 1日以上開いているので、別の意図での予約変更の可能性

#### 20260101615 - 2件の予約
- 時間帯: 2026/1/30 0:25:57 - 1:58:18（92分20秒）
- パターン: canceled×1 → pending×1
- 予約枠: 同じ11:00
- **分析**: 1時間半後に再予約。最初の予約がcanceledになったのを見て再度予約した可能性

#### 20260101630 - 2件の予約
- 時間帯: 2026/1/30 12:43:40 - 13:50:06（66分26秒）
- パターン: canceled×1 → pending×1
- 予約枠変更: 12:45 → 14:15

### 2. 全てcanceled（2人）
**これらは予約が確定していない可能性が高い**

#### 20251200128 - 4件の予約
- 時間帯: 2026/1/26 19:43:46 - 2026/1/27 2:40:35（6時間56分）
- パターン: canceled×4
- 詳細:
  - 1/26 19:43:46: 10:00 → canceled
  - 1/26 20:11:05: 10:30 → canceled（27分後）
  - 1/26 20:52:35: 13:00 → canceled（41分後）
  - 1/27 02:40:35: 14:45 → canceled（5時間48分後）
- **分析**: 予約枠を変えながら4回試行したが全て失敗。深夜の最後の試行も失敗している

#### 20260101146 - 2件の予約
- 時間帯: 2026/1/20 19:42:37 - 19:46:39（4分1秒）
- パターン: canceled×2
- 詳細:
  - 19:42:37: 11:45 → canceled
  - 19:46:39: 11:45 → canceled（4分1秒後）
- **分析**: 同じ時間枠で4分間隔で2回試行したが両方失敗

## 問題パターンの分析

### 短時間連続予約（9-14秒間隔）
以下のケースで短時間での連続予約が見られる:

1. **20260101576**: 最も顕著
   - 9秒、13秒、14秒の間隔で4回連続
   - 明らかにユーザーが「予約ボタンを押しても反応がない」と感じて連打

2. **20260100321**: 
   - 9秒間隔で1回
   - その後7分30秒後に再試行

3. **20260101146**:
   - 4分1秒間隔（比較的長い）
   - エラーメッセージを見て再試行した可能性

### 時間差のパターン
- **10秒未満**: DBレスポンス遅延による連打（2ケース、3件）
- **数分**: UIフィードバック不足による再試行（多数）
- **数十分〜数時間**: 意図的な予約変更の可能性（3ケース）
- **1日以上**: 別の意図での予約変更（1ケース）

## 根本原因の推定

### 主要原因: Supabase書き込み遅延
1. **症状**: 予約作成に10-30秒かかる
2. **ユーザー行動**: 
   - 「予約ボタンを押しても反応がない」
   - 「エラーが出た」と判断して再試行
   - 短時間に連続でボタンクリック
3. **結果**: 
   - 最初の数回はcanceled（DBに反映されず？）
   - 最後の1回がpending（やっと成功）

### 副次的原因: UIフィードバック不足
- ローディング表示が不十分
- エラーメッセージが不明確
- 予約完了の確認が分かりにくい

## 20260100211との比較

### 共通点
- 「最後の1件だけpending」パターン
- 短時間での連続予約
- canceledとpendingの混在

### 相違点
- 20260100211: 15件（最も多い）
- 20260100321: 5件
- 20260101576: 5件
- その他: 2件

## 推奨対応

### 緊急対応
1. **データ整合性確認**
   - 全てcanceledの2人（20251200128, 20260101146）は予約が成立していない
   - 本日の診療に影響がないか確認必要

2. **患者への連絡**
   - canceledのみの患者に予約状況を確認
   - 必要に応じて再予約を案内

### 中期対応（既に実施済み？）
1. **UIフィードバック改善**
   - ローディング表示の追加
   - 予約完了の明確な表示
   - ボタンの二重送信防止

2. **エラーハンドリング改善**
   - タイムアウト値の調整
   - リトライロジックの実装
   - エラーメッセージの改善

3. **パフォーマンス改善**
   - Supabase書き込みの最適化
   - インデックスの見直し
   - 同時実行制御の改善

## 結論

今回の調査で、20260100211と同じパターンの重複予約が**少なくとも6人**いることが確認されました。特に以下の2人は深刻です:

1. **20260101576**: 2分30秒の間に5回予約（9-14秒間隔で連打）
2. **20260100321**: 48分の間に5回予約（9秒間隔の連打含む）

これは明らかに**Supabaseの書き込み遅延**が原因で、ユーザーが「反応がない」と感じて連続クリックした結果です。

また、**全てcanceledの2人**は予約が成立していない可能性が高く、本日の診療に影響する恐れがあります。早急な確認と対応が必要です。

# データ同期状況レポート

**作成日時**: 2026-01-28

---

## データ比較サマリー

| データ種別 | Googleシート | Supabase | 状態 |
|-----------|-------------|----------|------|
| **問診データ** | 1,974件（GAS取得）<br>2,564行（シート実行数） | 1,996件 | ✅ ほぼ同期 |
| **予約データ** | 2,368行（全履歴） | 42件（今後の予約のみ） | ✅ 正常（運用方針） |
| **注文データ** | 1,956行 | 1,809件 | ⚠ 約150件の差分 |

---

## 詳細分析

### 1. 問診データ（intake）

**Googleシート（問診シート）**: 2,564行
- GAS経由で取得: 1,974件
- 差分: 約590行は空行やヘッダー行と推測

**Supabase（intakeテーブル）**: 1,996件
- GASより22件多い（バックフィル後の差分）

**結論**: ✅ **ほぼ同期されている**
- 微差はバックフィルタイミングやデータ追加のタイムラグ
- 問題なし

---

### 2. 予約データ（reservations）

**Googleシート（予約シート）**: 2,368行
- **過去の全履歴を含む**（キャンセル、診察済み含む）
- 2024年以降の全予約データ

**Supabase（reservationsテーブル）**: 42件
- **今後の予約のみ**（1/28〜1/30）
- 全て pending ステータス
- 診察済み・キャンセルは削除または除外される運用

**結論**: ✅ **正常な運用**
- Supabaseは「これから診察する予約」のみ管理
- 過去の履歴はGoogleシートで保管
- この運用方針は効率的

**同期タイミング**:
- 新規予約: 即座に Supabase に追加
- 診察完了後: Supabase から削除？（要確認）
- 過去の予約: Googleシートのみに残る

---

### 3. 注文データ（orders）

**Googleシート（Square Webhook）**: 1,956行

**Supabase（ordersテーブル）**: 1,809件
- 決済完了: 983件
- 承認済み: 17件
- 返金済み: 14件（Supabaseに残っている）
- **Patient IDなしの注文: 0件**（全て除外済み）

**差分**: 約147件

**差分の原因（確認済み）**:
1. ✅ **Patient IDがない注文を除外**（問診前に決済しようとした人など）
2. ✅ Googleシートのヘッダー行や空行
3. ✅ テストデータ
4. ✅ 決済失敗データ（Square Webhookには記録されるがSupabaseには入らない）

**重要**: 返金された注文もSupabaseに残っています（14件確認）

**結論**: ✅ **正常な運用**
- Patient IDがある有効な注文のみがSupabaseに同期されている
- 最近30日の注文（1,809件）は全てSupabaseに入っている
- 問題なし

---

## 運用方針の整理

### 現在の運用（推測）

#### 問診・患者データ
- **Googleシート**: マスターデータとして全履歴を保管
- **Supabase**: アプリケーションの高速アクセス用（全データ）

#### 予約データ
- **Googleシート**: 全履歴（キャンセル・診察済み含む）
- **Supabase**: **今後の予約のみ**（カルテUIで使用）

#### 注文データ
- **Googleシート**: Square Webhookからの全履歴
- **Supabase**: アプリケーション用（マイページ、配送管理）

---

## 推奨事項

### ✅ 現状維持で問題ないもの

1. **問診データ**: ほぼ完全に同期されており問題なし
2. **予約データ**: 今後の予約のみをSupabaseで管理する運用は効率的
3. **注文データ**: Patient IDがある有効な注文は全て同期されている

### 📝 運用ルールの明文化（推奨）

1. **過去の予約の扱い**:
   - 診察完了後、Supabase reservationsから削除される？
   - それとも status が更新されるだけ？
   - 運用ルールの明文化が必要

2. **データ保持期間**:
   - Supabaseにどの期間のデータを保持するか明確化
   - 予約: 今後の予約のみ（現在の運用）
   - 問診: 全データ
   - 注文: 全データ（返金含む）

3. **除外ルール**:
   - 注文: Patient IDなしは除外（確認済み）
   - 決済失敗: 除外（確認済み）
   - 返金: Supabaseに残す（確認済み）

---

## 同期の健全性チェック

### 毎日実行すべき確認

```bash
# 1. 全テーブルのレコード数確認
node --env-file=.env.local check-all-supabase-tables.mjs

# 2. シートとSupabaseの比較
node --env-file=.env.local check-sheet-vs-supabase.mjs

# 3. 当日の予約が全て同期されているか
node --env-file=.env.local check-reservations-20260128.mjs
```

### 週次で実行すべき確認

```bash
# 1. 不通データの同期状況
node --env-file=.env.local check-no-answer-in-supabase.mjs

# 2. 注文データの漏れチェック
# （スクリプト作成推奨）
```

---

## まとめ

現在の同期状況は**全て正常**です。

- ✅ 問診データ: 同期完了（1,996件）
- ✅ 予約データ: 今後の予約のみを管理（42件）
- ✅ 注文データ: Patient IDがある有効な注文は全て同期済み（1,809件）

### データ差分の理由（全て確認済み）

| データ種別 | Googleシート | Supabase | 差分の理由 |
|-----------|-------------|----------|-----------|
| 問診 | 2,564行 | 1,996件 | ヘッダー行、空行、フォーマット行 |
| 予約 | 2,368行 | 42件 | **過去の予約・キャンセル履歴を除外**（運用方針） |
| 注文 | 1,956行 | 1,809件 | **Patient IDなし、決済失敗を除外**（バリデーション） |

### 運用方針（確認済み）

1. **予約データ**: 今後の予約のみSupabaseで管理、過去履歴はGoogleシートに残す
2. **注文データ**: Patient IDがある有効な注文のみ同期、返金データも保持
3. **問診データ**: 全データをSupabaseに同期

### 今後の推奨事項

1. ✅ 定期的な同期確認の自動化（スクリプト作成済み）
2. 📝 データ保持期間のポリシーを文書化
3. 📝 予約データのクリーンアップルールを明文化（診察後にreservationsから削除するか）

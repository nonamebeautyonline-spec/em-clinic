# インシデント報告: intake API 個人情報消失 (2026-02-08)

## 概要
問診完了時に患者の個人情報（カナ・性別・生年月日・電話番号）およびLINE UIDがDBから消失するバグが発生。14名が影響を受けた。

## タイムライン

| 時刻 | イベント |
|------|---------|
| 午前 | 管理画面マイページで問診が「完了済み」表示だが、顧客マイページでは未完了 → 調査開始 |
| 15:00頃 | admin view-mypage API の hasIntake 判定を ng_check ベースに修正 (cd57a3f) |
| 15:30頃 | 顧客 mypage API も同じバグ → 修正 & push (683ba5b) |
| 16:00頃 | Redis キャッシュ（TTL=30分）にstaleデータ → 24人分クリア |
| 16:30頃 | masterInfo 第2 upsert が reserve_id/date/time を null で上書き → 修正 (100c7e5) |
| 17:00頃 | masterInfo 第2 upsert 自体を完全削除（Lステップ廃止のため）(a9da49e) |
| 17:10頃 | patient_name の上書き防止修正 (9b44bfe) |
| 17:30頃 | answerers upsert の既存データ保持修正 (78a20e6) |
| 18:00頃 | 個人情報消失した患者向け `/repair` ページ作成 (4e50c87) |
| 18:30頃 | **根本原因発見**: intake 第1 upsert の `answers: fullAnswers` が既存 JSONB を丸ごと上書き → 修正 (bf3361d) |
| 18:45頃 | 14人に LINE で repair URL 送信 |
| 19:00頃 | 平井千聖の LINE UID 復元 + LINE_ 仮レコード統合 |
| 19:15頃 | intake API に LINE_ 仮レコード自動統合ロジック追加 (52d1f05) |

## 根本原因

### 問題1: answers JSONB の丸ごと上書き（根本原因）
**ファイル**: `app/api/intake/route.ts`

問診フォーム (`app/intake/page.tsx`) は医療質問（ng_check, 病歴, アレルギー等）のみを送信し、個人情報（カナ, 性別, 生年月日, 電話番号）は含まない。

旧コード:
```typescript
const fullAnswers = {
  ...answersObj,        // リクエストbodyの問診回答のみ
  カナ: nameKana,       // ← bodyに無いので "" (空文字)
  性別: sex,            // ← ""
  生年月日: birth,      // ← ""
  電話番号: tel,        // ← ""
};
// ...
answers: fullAnswers,   // ← 既存のanswers JSONBを取得せず丸ごと上書き
```

**結果**: 登録時に入力された個人情報が問診完了時に空文字で上書きされた。

修正後:
```typescript
const existingAnswers = (existingRecord?.answers as Record<string, unknown>) || {};
const mergedAnswers = {
  ...existingAnswers,   // 既存の値を下地に
  ...answersObj,        // 新しい問診回答で上書き
  // 個人情報は実際に値がある場合のみ上書き
  ...(name ? { 氏名: name, name } : {}),
  ...(sex ? { 性別: sex, sex } : {}),
  // ...
};
```

### 問題2: masterInfo 第2 upsert（副次原因、削除済み）
GASレスポンスの masterInfo で intake を再 upsert していたが、masterInfo に個人情報が含まれないため空値で上書き。Lステップ廃止に伴い処理自体を削除。

### 問題3: line_id の上書き
旧コード: `line_id: lineId || null` → 問診フォームは line_id を送らないので null で上書き。
修正後: `line_id: lineId || existingRecord?.line_id || null`

### 問題4: LINE_ 仮レコードの残留
line_id が null になったことで、登録時の仮レコード削除処理（line_id で検索して削除）がヒットしなくなり、管理画面で同一人物が2つ表示された。

## 影響範囲
- **影響者数**: 14人（予約→問診 フローで問診を後から完了した患者）
- **消失データ**: intake.answers 内のカナ, 性別, 生年月日, 電話番号 + intake.line_id
- **復旧不可データ**: 個人情報はDBにもGASにも残っていなかったため、患者自身による再入力が必要

## 対応内容
1. `/repair` ページを作成し、患者にLINEで再入力を依頼
2. 14人中8人が入力完了（2/8 19:30時点）
3. LINE UID は answerers テーブルから復元
4. LINE_ 仮レコードの削除 + message_log の統合

## 再発防止
1. intake upsert で既存 answers を DB から取得してマージするよう修正
2. 個人情報フィールドは空文字の場合は既存値を保持（条件付きスプレッド）
3. line_id も既存値を保持するフォールバック追加
4. 問診完了時に LINE_ 仮レコードが残っていたら自動統合するロジック追加

## 教訓
- **upsert で JSONB を書き込む際は、既存データを必ず取得してマージすること**。リクエストbodyだけから構築すると、送信されないフィールドが消える。
- フォームが送信するフィールドとAPIが期待するフィールドの不一致に注意。問診フォームは医療質問のみ、個人情報は別フローで入力される。
- `value || null` パターンは既存値を消す可能性がある。`value || existingValue || null` のフォールバックが必要。

## 関連コミット
| commit | 内容 |
|--------|------|
| cd57a3f | admin view-mypage の hasIntake 判定修正 |
| 683ba5b | customer mypage の hasIntake 判定修正 |
| 100c7e5 | masterInfo の reserve_id 保持修正 |
| a9da49e | masterInfo 第2 upsert 削除 |
| 9b44bfe | patient_name 上書き防止 |
| 78a20e6 | answerers upsert 既存データ保持 |
| 4e50c87 | /repair ページ + API 作成 |
| 1a066b6 | repair ページ電話番号ラベル追加 |
| bf3361d | **answers マージ修正（根本原因の修正）** |
| 52d1f05 | LINE_ 仮レコード自動統合 |

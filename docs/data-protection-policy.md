# データ保護ポリシー

最終更新: 2026-02-24
適用対象: Lオペ for CLINIC (全テナント)

---

## 1. 取り扱う個人情報の種類

### 患者情報

| データ種別 | 保存先 | 内容 |
|-----------|--------|------|
| 基本情報 | `patients` テーブル | 氏名、電話番号、メールアドレス、生年月日 |
| LINE情報 | `patients` テーブル | LINE UID、表示名、プロフィール画像URL |
| 問診情報 | `intake` テーブル | 問診回答 (症状・既往歴・アレルギー等)、医療情報 |
| カルテ情報 | `intake` / `reorders` テーブル | 診察記録、処方内容、SOAP記録 |
| 決済情報 | `orders` テーブル | 氏名、電話番号、メール、配送先住所、郵便番号 |
| 再処方情報 | `reorders` テーブル | 申請内容、承認記録、カルテノート |
| 予約情報 | `reservations` テーブル | 予約日時、予約ステータス |
| トーク履歴 | `message_log` テーブル | LINE送受信メッセージ |
| セグメント情報 | `patient_segments` テーブル | RFM分析結果、セグメント分類 |

### 管理者情報

| データ種別 | 保存先 | 内容 |
|-----------|--------|------|
| アカウント情報 | `admin_users` テーブル | ユーザー名、メール、パスワードハッシュ (bcrypt) |
| セッション情報 | `admin_sessions` テーブル | トークンハッシュ (SHA256)、IPアドレス、User-Agent |
| 操作ログ | `audit_logs` テーブル | 操作内容、IPアドレス、タイムスタンプ |

### 要配慮個人情報 (医療データ)

本サービスは医療情報を取り扱うため、以下は特に厳格に管理する。

- 問診回答 (症状・既往歴・アレルギー・服薬状況)
- カルテ記録 (診察所見・処方内容)
- 音声カルテデータ (文字起こし結果)

---

## 2. 個人情報の保存期間

| データ種別 | 保存期間 | 根拠 |
|-----------|---------|------|
| カルテ・診療記録 | **5年** | 医師法24条 (診療録の保存義務) |
| 処方記録 | **3年** | 薬剤師法28条 |
| 決済記録 | **7年** | 法人税法施行規則 (帳簿保存義務) |
| 問診データ | **5年** (カルテと同期間) | 診療記録の一部として |
| トーク履歴 | **2年** | 業務上の必要期間 |
| 監査ログ | **3年** | セキュリティ監査要件 |
| セッションログ | **1年** | セキュリティ監査要件 |
| Webhookイベント | **30日** | 冪等チェック用 (自動削除) |

### 保存期間経過後の処理

- 自動削除またはアーカイブ (将来実装)
- 削除時は物理削除 (論理削除ではない)
- 削除ログを監査ログに記録

---

## 3. データ削除ポリシー

### 患者からの削除要求

患者からデータ削除の要求があった場合、以下の手順で対応する。

1. **本人確認**: LINE認証またはSMS認証で本人確認
2. **削除範囲の確認**: 法的保存義務があるデータは削除対象外であることを説明
3. **削除実行**: `/api/admin/delete-patient-data` APIで実行
4. **削除記録**: 監査ログに削除操作を記録

### 削除可能なデータ

| データ | 削除可否 | 備考 |
|--------|:--------:|------|
| 患者基本情報 | 可 | 手動削除 |
| 問診データ | 可 | APIで一括削除可能 |
| 予約データ | 可 | ステータスを「キャンセル」に変更 (論理削除) |
| トーク履歴 | 可 | 手動削除 |
| タグ・マーク | 可 | 患者削除時に連動削除 |

### 削除不可のデータ (法的保存義務)

| データ | 保存義務 | 根拠 |
|--------|---------|------|
| カルテ記録 | 5年間保存必須 | 医師法24条 |
| 決済記録 | 7年間保存必須 | 法人税法 |
| 監査ログ | 削除不可 | セキュリティポリシー |

### テナント解約時

テナント解約時は以下の手順で全データを削除する。

1. 解約日から **30日間の猶予期間** (データエクスポート用)
2. 猶予期間後、テナントに紐づく全データを物理削除
3. 削除完了通知をテナント管理者に送付
4. プラットフォーム監査ログに記録 (テナントデータは削除、ログは保持)

---

## 4. アクセス制限

### ロール別アクセス権限

| ロール | 患者情報閲覧 | 患者情報編集 | カルテ閲覧 | カルテ編集 | システム設定 |
|--------|:----------:|:----------:|:--------:|:--------:|:----------:|
| プラットフォーム管理者 | 全テナント | 全テナント | 全テナント | 不可 | 可 |
| テナント管理者 (admin) | 自テナント | 自テナント | 自テナント | 可 | 自テナント |
| テナント閲覧者 (viewer) | 自テナント | **不可** | 自テナント | **不可** | **不可** |
| 医師 (doctor) | 自テナント | 不可 | 自テナント | 可 | 不可 |
| 患者 | 自分のみ | 自分のみ | 不可 | 不可 | 不可 |

### テナント分離

- 全データはテナントID (`tenant_id`) で分離
- サブドメイン方式: `{slug}.lope.jp`
- ミドルウェアで全リクエストにテナントIDを付与
- RLS (Row Level Security) でDB層でも分離
- テナント間のデータアクセスは技術的に不可能

### 実装による制限

| 制限 | 実装方式 |
|------|---------|
| viewerの書き込みブロック | middleware.ts (POST/PUT/PATCH/DELETE拒否) |
| テナント分離 | withTenant() + RLS |
| 患者の自データ限定 | JWT内のpatient_idでフィルタ |
| Dr認証 | Basic認証 (middleware.ts) |
| プラットフォーム制限 | adminサブドメイン/localhostのみ |

---

## 5. データ持ち出し禁止ルール

### 禁止事項

1. **個人情報の外部転送禁止**: 患者データをメール・チャット・外部ストレージに転送してはならない
2. **スクリーンショット制限**: カルテ・問診データのスクリーンショット取得は業務上必要な場合のみ
3. **データエクスポートの制限**: CSVエクスポート機能は管理者ロール以上のみ利用可能
4. **開発環境への本番データ複製禁止**: 本番の患者データを開発・テスト環境にコピーしてはならない

### 許可される操作

| 操作 | 条件 |
|------|------|
| CSV/Excelエクスポート | 管理者ロール以上、監査ログに記録 |
| 配送リスト出力 | 配送業務に必要な最小限の情報のみ |
| レポート出力 | 集計データのみ (個人を特定できない形式) |
| バックアップ | Supabase自動バックアップのみ (手動コピー禁止) |

### 外部サービスへのデータ送信

| 送信先 | 送信データ | 目的 | 暗号化 |
|--------|-----------|------|:------:|
| LINE Messaging API | LINE UID、メッセージ内容 | メッセージ送受信 | TLS |
| Square / GMO | 決済金額、注文ID | 決済処理 | TLS |
| Deepgram / Groq | 音声データ | 文字起こし | TLS |
| Anthropic (Claude) | テキスト (個人情報マスク済み) | AIカルテ生成・AI返信 | TLS |
| Sentry | エラー情報 (個人情報含まない) | エラー監視 | TLS |
| Resend | メールアドレス、メール本文 | メール送信 | TLS |

### AI連携時の個人情報取り扱い

- Claude APIへの送信時、可能な限り個人情報をマスクする
- 患者名・電話番号・メールアドレスはAIに送信しない (問診内容・症状のみ)
- AIの学習データとして使用しないプラン (Anthropic Business Plan) を使用

---

## 6. 暗号化方針

### 保存時の暗号化 (At-Rest)

| レイヤー | 方式 | 対象 |
|---------|------|------|
| DB | Supabase (AWS RDS暗号化) | 全テーブル |
| アプリケーション | AES-256-GCM | テナント設定 (APIキー・シークレット) |
| パスワード | bcrypt | 管理者パスワード |
| セッション | SHA256ハッシュ | JWTトークン |

### 通信時の暗号化 (In-Transit)

| 通信経路 | 方式 |
|---------|------|
| ブラウザ ↔ Vercel | TLS 1.2+ (HTTPS強制) |
| Vercel ↔ Supabase | TLS 1.2+ |
| Vercel ↔ 外部API | TLS 1.2+ |

---

## 7. インシデント時のデータ保護

### データ漏洩が疑われる場合

1. **即時**: 該当テナントの全セッションを無効化
2. **1時間以内**: 影響範囲の特定 (監査ログ・アクセスログ確認)
3. **24時間以内**: 影響を受けた患者の特定と通知準備
4. **72時間以内**: 個人情報保護委員会への報告 (漏洩が確定した場合)

### 報告義務

- **個人情報保護法** (2022年改正): 漏洩等が発生した場合、個人情報保護委員会への報告義務
- **報告基準**: 要配慮個人情報 (医療データ) の漏洩は1件でも報告対象

---

## 8. 定期レビュー

| 頻度 | 内容 |
|------|------|
| 月次 | アクセス権限の棚卸し (不要アカウント削除) |
| 四半期 | データ保護ポリシーの見直し |
| 年次 | 外部セキュリティ監査 (推奨) |
| 随時 | 法令改正への対応 |

---

## 9. 関連ドキュメント

- [セキュリティ運用チェックリスト](./security-operations.md)
- [障害対応ランブック](./incident-response.md)
- [ドメイン境界ドキュメント](./domain-boundaries.md)

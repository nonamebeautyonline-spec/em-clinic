# 障害対応ランブック (Incident Response Runbook)

最終更新: 2026-02-24

## 1. 重大度定義

### P0 — 致命的 (即時対応)

| 定義 | 例 |
|------|-----|
| サービス全体が停止 | Vercelダウン、Supabase接続不能 |
| 患者データの漏洩・消失 | DB誤削除、RLS設定ミス |
| 決済処理の異常 | 二重課金、決済不能 |
| セキュリティ侵害 | 不正アクセス、管理者アカウント乗っ取り |

- **対応開始**: 検知後 **15分以内**
- **顧客連絡**: **1時間以内**
- **復旧目標**: **4時間以内**

### P1 — 重大 (1時間以内に対応開始)

| 定義 | 例 |
|------|-----|
| 主要機能が利用不能 | LINE送受信不能、予約機能停止 |
| データ不整合 | intake上書き、患者情報の欠落 |
| 一部テナントの機能停止 | テナント設定破損 |

- **対応開始**: 検知後 **1時間以内**
- **顧客連絡**: **4時間以内**
- **復旧目標**: **24時間以内**

### P2 — 中程度 (翌営業日対応)

| 定義 | 例 |
|------|-----|
| 一部機能の劣化 | ダッシュボード表示遅延、レポート不正確 |
| 非クリティカルなエラー | AI返信生成失敗、リマインダー遅延 |
| UIの不具合 | レイアウト崩れ、表示バグ |

- **対応開始**: **翌営業日**
- **顧客連絡**: 影響が大きい場合のみ
- **復旧目標**: **3営業日以内**

---

## 2. 検知方法

### 自動検知

| 監視 | ツール | 通知先 |
|------|--------|--------|
| アプリケーションエラー | Sentry | メール + Slack (設定時) |
| ヘルスチェック | Cron `health-report` (毎日) | LINE管理グループ |
| データ整合性チェック | GitHub Actions `data-consistency-check.yml` (毎日) | GitHub Issue自動作成 |
| セキュリティアラート | `security_alerts` テーブル | プラットフォーム管理画面 |
| デプロイ失敗 | Vercel | メール |

### 手動検知

- 顧客からの問い合わせ
- 管理画面での異常値発見
- 定期的なログ確認

---

## 3. 初動フロー

### Step 1: 状況把握 (最初の15分)

```
1. Sentry でエラー内容・発生頻度・影響範囲を確認
2. Vercel ダッシュボードでデプロイ状態・ログを確認
3. Supabase ダッシュボードでDB接続状態を確認
4. 重大度を判定 (P0 / P1 / P2)
```

### Step 2: 影響範囲の特定

```
1. 影響を受けているテナント数を確認
2. 影響を受けている機能を特定
3. 直近のデプロイ・変更を確認 (git log)
4. 同時刻の外部サービス障害を確認 (LINE, Square, Supabase status)
```

### Step 3: 応急処置

| 障害パターン | 応急処置 |
|-------------|---------|
| デプロイ起因 | Vercelで前バージョンにロールバック |
| DB起因 | Supabaseバックアップから復元検討 |
| 外部API起因 | 該当機能を一時無効化 (メンテナンスモード) |
| セキュリティ | 全セッション無効化 (`revokeAllSessions`) |

### Step 4: ログ保全

```bash
# Vercelログ取得
# Vercelダッシュボード > Functions > Logs からダウンロード

# Supabase監査ログ取得
# Supabase SQL Editor で:
SELECT * FROM audit_logs
WHERE created_at >= '障害発生時刻'
ORDER BY created_at DESC;

# セキュリティアラート取得
SELECT * FROM security_alerts
WHERE created_at >= '障害発生時刻'
ORDER BY created_at DESC;
```

---

## 4. 顧客連絡テンプレート

### P0/P1 — 障害発生通知

```
【障害発生のお知らせ】

いつもご利用ありがとうございます。

現在、以下の障害が発生しております。

■ 発生日時: YYYY/MM/DD HH:MM
■ 影響範囲: [具体的な影響内容]
■ 現在の状況: 原因調査中 / 復旧作業中

復旧完了次第、改めてご連絡いたします。
ご不便をおかけし申し訳ございません。

Lオペ for CLINIC 運営チーム
```

### P0/P1 — 復旧完了通知

```
【障害復旧のお知らせ】

先ほどお知らせした障害について、
復旧が完了しましたのでご報告いたします。

■ 発生日時: YYYY/MM/DD HH:MM
■ 復旧日時: YYYY/MM/DD HH:MM
■ 原因: [原因の概要]
■ 影響: [影響の詳細]
■ 再発防止策: [対策の概要]

ご迷惑をおかけし申し訳ございませんでした。
今後とも何卒よろしくお願いいたします。

Lオペ for CLINIC 運営チーム
```

### データ消失時 — 個別連絡

```
【データに関するお知らせ】

いつもご利用ありがとうございます。

システム障害により、以下のデータに影響が発生いたしました。

■ 影響期間: YYYY/MM/DD HH:MM 〜 YYYY/MM/DD HH:MM
■ 影響内容: [具体的な影響]
■ 復旧状況: [復旧済み / 一部復旧不能]
■ 対応: [補償・再入力依頼等]

大変ご迷惑をおかけし、深くお詫び申し上げます。
ご不明点がございましたらお気軽にお問い合わせください。

Lオペ for CLINIC 運営チーム
```

---

## 5. 過去のインシデントと教訓

### 事故1: intake消失事故 (2026-02-08)

| 項目 | 内容 |
|------|------|
| 重大度 | P1 |
| 影響 | 23人分のintakeレコードが消失 |
| 原因 | `upsert({ onConflict: "patient_id" })` の誤用。patient_idにユニーク制約がないためサイレント失敗 |
| 復旧 | 手動でデータ再作成 |
| 再発防止 | upsert使用禁止、`select→insert/update` パターンに統一 |
| 教訓 | **intakeテーブルでupsertは絶対に使わない** |

### 事故2: answerer.name上書き事故 (2026-02-09)

| 項目 | 内容 |
|------|------|
| 重大度 | P1 |
| 影響 | 665件のanswerer.nameがnullに上書き |
| 原因 | intake/route.tsでanon keyを使用。RLSでSELECTがブロックされnull取得→nullで上書き |
| 復旧 | バックアップからデータ復元 |
| 再発防止 | intake/route.tsは必ず`supabaseAdmin`を使用 |
| 教訓 | **anon keyでのSELECT結果がnullの場合、RLSブロックを疑う** |

### 共通教訓

1. **DBのUPDATEは必ずid指定** — patient_id指定は複数レコードを全上書きする危険あり
2. **intake.statusのNG判定には`.not("status", "is", null)`必須** — null判定漏れで正常データを異常扱い
3. **本番データ変更前にSELECTで確認** — UPDATE/DELETEの影響行数を事前チェック

---

## 6. ロールバック手順

### Vercelデプロイのロールバック

```
1. Vercelダッシュボード > Deployments
2. 正常動作していたデプロイを選択
3. "..." > "Promote to Production" をクリック
4. 確認画面で "Promote" を実行
5. 動作確認
```

### DBマイグレーションのロールバック

```
1. 問題のマイグレーションを特定
2. 逆のSQLを手動で実行 (Supabase SQL Editor)
3. supabase/migrations/ から問題ファイルを削除
4. 影響テーブルのデータ整合性を確認
```

### メンテナンスモード有効化

```
POST /api/platform/system/maintenance
{
  "enabled": true,
  "message": "メンテナンス中です。しばらくお待ちください。"
}
```

---

## 7. 再発防止報告書テンプレート

```markdown
# 障害報告書

## 概要
- 発生日時:
- 復旧日時:
- 重大度: P0 / P1 / P2
- 影響範囲:
- 影響顧客数:

## タイムライン
| 時刻 | アクション |
|------|-----------|
| HH:MM | 障害検知 |
| HH:MM | 初動対応開始 |
| HH:MM | 原因特定 |
| HH:MM | 応急処置完了 |
| HH:MM | 恒久対策完了 |

## 根本原因
[技術的な原因の詳細]

## 影響詳細
[影響を受けたデータ・機能・顧客の詳細]

## 対応内容
1. 応急処置: [内容]
2. 恒久対策: [内容]

## 再発防止策
1. [技術的対策]
2. [プロセス改善]
3. [監視強化]

## 教訓
- MEMORY.mdへの追記内容:
- テスト追加:
- ドキュメント更新:
```

---

## 8. 24時間以内の対応方針

### 営業時間内 (9:00-18:00)

- P0: 即時対応。全作業を中断して障害対応に集中
- P1: 1時間以内に対応開始。進行中タスクの区切りをつけてから
- P2: 当日中に調査開始

### 営業時間外

- P0: Sentry/ヘルスレポートのアラートで検知 → 即時対応
- P1: 翌営業日の朝一で対応
- P2: 翌営業日の通常業務内で対応

### エスカレーション

| 状況 | アクション |
|------|-----------|
| 2時間以内に原因特定できない | 外部エンジニアに相談 |
| データ消失が判明 | Supabaseサポートに連絡 |
| セキュリティ侵害の疑い | 全セッション無効化 + パスワードリセット強制 |
| 決済異常 | Square/GMOサポートに連絡 + 該当決済を手動確認 |

---

## 9. 連絡先一覧

| サービス | 連絡先 | 用途 |
|---------|--------|------|
| Supabase | ダッシュボード > Support | DB障害・バックアップ復元 |
| Vercel | ダッシュボード > Support | デプロイ・DNS障害 |
| LINE Developers | 開発者コンソール | Messaging API障害 |
| Square | Developer Dashboard | 決済障害 |
| Upstash | ダッシュボード > Support | Redis障害 |
| Sentry | ダッシュボード | エラー監視設定 |
| Deepgram | ダッシュボード > Support | 音声認識障害 |
